parameters:
  - name: buildConfig
    displayName: Build Configuration to Use
    default: Debug
    values:
    - Debug
    - Release

trigger: none # https://aka.ms/obpipelines/triggers

variables:
- name: system.debug
  value: true
- name: BuildConfiguration
  value: ${{ parameters.buildConfig }}
- name: BuildPlatform
  value: 'AnyCPU'
- name: CDP_DEFINITION_BUILD_COUNT
  value: $[counter('', 0)] # needed for onebranch.pipeline.version task https://aka.ms/obpipelines/versioning
- name: WindowsContainerImage
  value: 'onebranch.azurecr.io/windows/ltsc2022/vse2022:latest' # Docker image which is used to build the project https://aka.ms/obpipelines/containers

- name: BuildOutput
  value: '$(Build.SourcesDirectory)\out'
- name: PackageOutput
  value: '$(BuildOutput)\packages'
- name: DllFilePath
  value: '$(Build.SourcesDirectory)\AzFilesSmbMIClient\Windows\dotnet\dll\Microsoft.Azure.AzFilesSmbMI.csproj'
- name: ExeFilePath
  value: '$(Build.SourcesDirectory)\AzFilesSmbMIClient\Windows\exe\AzFilesSmbMIClient.csproj'

resources:
  repositories:
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates # https://aka.ms/obpipelines/templates
  parameters:
    featureFlags:
      WindowsHostVersion:
        Version: 2022
      EnableCDPxPAT: false
    cloudvault: # https://aka.ms/obpipelines/cloudvault
      enabled: false
    globalSdl: # https://aka.ms/obpipelines/sdl
      # tsa:
      #  enabled: false # onebranch publish all sdl results to TSA. If TSA is disabled all SDL tools will forced into 'break' build mode.
      # credscan:
      #   suppressionsFile: $(Build.SourcesDirectory)\.config\CredScanSuppressions.json
      policheck:
        break: false # always break the build on policheck issues. You can disable it by setting to 'false'
      # suppression:
      #   suppressionFile: $(Build.SourcesDirectory)\.gdn\global.gdnsuppress
    nugetPublishing:
      feeds:
        - name: Official
          files_to_publish: '*.nupkg'
          continueOnConflict: false
    stages:
    - stage: build
      jobs:
      - job: main
        pool:
          type: windows  # read more about custom job pool types at https://aka.ms/obpipelines/yaml/jobs

        variables: # More settings at https://aka.ms/obpipelines/yaml/jobs
          ob_outputDirectory: '$(BuildOutput)' # this directory is uploaded to pipeline artifacts, reddog and cloudvault. More info at https://aka.ms/obpipelines/artifacts
          # https://aka.ms/obpipelines/sdl
          ob_sdl_binskim_break: false # always break the build on binskim issues, even if TSA enabled. You can disable it by setting to 'false'
          ob_sdl_roslyn_break: false
          #${{ if eq(variables['Build.SourceBranch'], 'refs/heads/main') }}: # conditionally enable symbolsPublishing for master branch only
          ob_symbolsPublishing_enabled: true # https://aka.ms/obpipelines/symbols
          # ob_sdl_suppression_suppressionFile: $(Build.SourcesDirectory)\.gdn\job.gdnsuppress
          ${{ if eq('true', 'true') }}:
            ob_nugetPublishing_enabled: true
        steps:
        #- checkout: self

        - task: UseDotNet@2
          displayName: 'Install .NET SDK'
          inputs:
            packageType: 'sdk'
            version: '9.x'
            includePreviewVersions: true
            installationPath: $(Agent.ToolsDirectory)/dotnet
        
        - task: NuGetToolInstaller@1

        - task: NuGetAuthenticate@1
          inputs:
            forceReinstallCredentialProvider: true            

        - task: onebranch.pipeline.version@1 # generates automatic version. For other versioning options check https://aka.ms/obpipelines/versioning
          displayName: 'Setup BuildNumber'  
          inputs:
            system: 'RevisionCounter'
            major: '1'
            minor: '0'
            exclude_commit: true

        - task: PowerShell@2
          displayName: 'Configure NuGet SSL Settings'
          inputs:
            targetType: 'inline'
            script: |
              # Set environment variables for SSL handling
              [Environment]::SetEnvironmentVariable("DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER", "0", "Machine")
              [Environment]::SetEnvironmentVariable("NUGET_CERT_REVOCATION_MODE", "offline", "Machine")
              [Environment]::SetEnvironmentVariable("DOTNET_SKIP_FIRST_TIME_EXPERIENCE", "true", "Machine")
              
              # Configure NuGet sources
              nuget sources clear
              nuget sources add -name "nuget.org" -source "https://api.nuget.org/v3/index.json"
              
              # List sources to verify
              nuget sources list              

        - task: MSBuild@1
          displayName: 'Restore and Build DLL Project'
          inputs:
            solution: '$(DllFilePath)'
            configuration: '$(BuildConfiguration)'
            platform: $(BuildPlatform)
            restoreNugetPackages: true
            verbosity: 'Detailed'
          env:
            DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER: 0
            NUGET_CERT_REVOCATION_MODE: offline

        - task: MSBuild@1
          displayName: 'Restore and Build EXE Project'
          inputs:
            solution: '$(ExeFilePath)'
            configuration: '$(BuildConfiguration)'
            platform: $(BuildPlatform)
            restoreNugetPackages: true
            verbosity: 'Detailed'
          env:
            DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER: 0
            NUGET_CERT_REVOCATION_MODE: offline
        
        - task: CopyFiles@2
          displayName: 'Copy DLL binaries to output directory'
          inputs:
            SourceFolder: 'AzFilesSmbMIClient\Windows\dotnet\dll\bin\$(BuildConfiguration)\net472'
            Contents: '**/*.dll'        
            TargetFolder: '$(BuildOutput)'

        - task: CopyFiles@2
          displayName: 'Copy EXE binaries to output directory'
          inputs:
            SourceFolder: '$(Build.SourcesDirectory)\AzFilesSmbMIClient\Windows\exe\bin\$(BuildConfiguration)\net472'
            Contents: '**/*.exe'            
            TargetFolder: '$(BuildOutput)'

        - task: PowerShell@2
          displayName: 'List files for signing verification'
          inputs:
            targetType: 'inline'
            script: |
              Write-Host "BuildOutput directory: $(BuildOutput)"
              if (Test-Path "$(BuildOutput)") {
                Write-Host "Files in BuildOutput:"
                Get-ChildItem -Path "$(BuildOutput)" -Recurse -File | ForEach-Object { 
                  Write-Host "  $($_.FullName)"
                }
                
                Write-Host "Executable and DLL files:"
                Get-ChildItem -Path "$(BuildOutput)" -Recurse -Include "*.dll","*.exe" | ForEach-Object { 
                  Write-Host "  $($_.FullName)"
                }
              } else {
                Write-Host "BuildOutput directory does not exist!"
              }

        - task: onebranch.pipeline.signing@1 
          displayName: 'Sign Binaries'
          inputs:
            command: 'sign'
            signing_profile: 'external_distribution' # https://eng.ms/docs/products/onebranch/signing/containerbuildsigning#signing_profile
            files_to_sign: '**/*.exe'
            search_root: '$(BuildOutput)'
          condition: and(succeeded(), ne(variables['Agent.JobStatus'], 'Failed'))
        
        - task: NuGetCommand@2
          inputs:
            command: 'pack'
            packagesToPack: '$(DllFilePath)'
            packDestination: '$(PackageOutput)'
        