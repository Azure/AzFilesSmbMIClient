parameters:
  - name: buildConfig
    displayName: Build Configuration to Use
    default: Debug
    values:
    - Debug
    - Release

trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
- name: buildConfiguration
  value: ${{ parameters.buildConfig }}

steps:
- checkout: self

- task: UseDotNet@2
  displayName: Setup .NET SDK Version 9.x
  inputs:
    packageType: sdk
    version: 9.x
    includePreviewVersions: true

- task: DotNetCoreCLI@2
  displayName: 'Build the Assembly'
  inputs:
    command: build
    versioningScheme: byBuildNumber
    arguments: '--configuration $(BuildConfiguration)'
    projects: $(Build.SourcesDirectory)/Windows/exe/AzFilesSmbMIClient.csproj

- task: EsrpCodeSigning@3
  displayName: 'Sign Binary Files'
  inputs:
    ConnectedServiceName: 'ESRP Code Signing'
    FolderPath: '$(Build.SourcesDirectory)'
    Pattern: '**/*.exe,**/*.dll'
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
        {
          "KeyCode": "CP-230012",
          "OperationCode": "SigntoolSign",
          "Parameters": {
            "OpusName": "Microsoft",
            "OpusInfo": "http://www.microsoft.com",
            "FileDigest": "/fd \"SHA256\"",
            "PageHash": "/NPH",
            "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
          },
          "ToolName": "sign",